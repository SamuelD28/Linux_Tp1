#!/bin/bash
#Script pur la validation des fichiers

directoryATraiter=../Àtraiter
directoryTraites=../Traités
directoryInvalides=../Invalides

fichiers=$(ls $directoryATraiter)

regexNomCourriel="\"(\w|\s)*\"\s<\w*@\w*\.com>"
regexDate="(Mon|Tue|Wed|Thu|Fri|Sat|Sun),\s([0-9]\s|1[0-9]\s|2[0-9]\s|3[0-1]\s)(Jul|Aug|Sep|Oct|Nov|Dec|Jan|Feb|Mar|Apr|May|Jun)\s(201[89])\s(([0-1][0-9]|2[0-3]):[0-5][0-9]:[0-5][0-9])"
regexSujet="(\w|\s){3,20}"
regexMessage=".*\S.*"

formatValid="\e[92m%-22s%s\e[39m\n"
formatInvalid="\e[31m%-22s%s\e[39m\n"

line='----------------------------------------'

for fichier in $fichiers
do
	isValid=1
	erreurMessage=
	echo -e "\e[96m\n~~~~~~~~$fichier~~~~~~~~\e[39m";
	
	auteur=$(cut -f1 -d ';' $directoryATraiter/$fichier)
	if [[ $auteur =~ $regexNomCourriel ]]
		then
			printf "$formatValid" "Auteur" "Valide"
		else
			printf "$formatInvalid" "Auteur" "Invalide"
			isValid=0
	fi		
	
	date=$(cut -f2 -d ';' $directoryATraiter/$fichier)
	if [[ $date =~ $regexDate ]]
		then
			printf "$formatValid" "Date" "Valide"
		else
			printf "$formatInvalid" "Date" "Invalide"
			isValid=0
	fi
	
	sujet=$(cut -f3 -d ';' $directoryATraiter/$fichier)
	if [[ $sujet =~ $regexSujet ]]
		then
			printf "$formatValid" "Sujet" "Valide"
		else
			printf "$formatInvalid" "Sujet" "Invalide"
			isValid=0
	fi
	
	destinataire=$(cut -f4 -d ';' $directoryATraiter/$fichier)
	if [[ $destinataire =~ $regexNomCourriel  ]]
		then
			printf "$formatValid" "Destinataire" "Valide"
		else
			printf "$formatInvalid" "Destinataire" "Invalide"
			isValid=0
	fi
	
	message=$(cut -f5 -d ';' $directoryATraiter/$fichier)
	if [[ $message =~ $regexMessage  ]]
		then
			printf "$formatValid" "Message" "Valide"
		else
			printf "$formatInvalid" "Message" "Invalide"
			isValid=0
	fi 
	
	if [ $isValid -eq 0 ]
		then
			$(mv $directoryATraiter/$fichier $directoryInvalides)
		else
			company=$(echo "$auteur" | egrep -o "<\w*@\w*\.com>")
			companyLenght=$(( ${#company} - 2 ))
			company=${company:1:companyLenght}
			$(mkdir $directoryTraites/$company)
			
			nom=$(echo "$auteur" | egrep -o "^\"(\w|\s)*\"")
			nom=${nom//' '/_}
			nomLenght=$(( ${#nom} - 2 ))
			nom=${nom:1:nomLenght}
			$(mkdir $directoryTraites/$company/$nom)
			
			$(mv $directoryATraiter/$fichier $directoryTraites/$company/$nom)
	fi
	
	echo -e "\e[96m////////////////////////////\e[39m";
done
